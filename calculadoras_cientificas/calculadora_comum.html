<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora Comum - thIAguinho Soluções</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <style>
        :root {
            --common-bg: #1A1A1A;
            --display-bg: #2C2C2C;
            --btn-bg: #404040;
            --btn-hover-bg: #555555;
            --operator-bg: #FF9F0A;
            --operator-hover-bg: #FFB03A;
            --special-bg: #D4D4D2;
            --special-text: #1A1A1A;
            --text-light: #FFFFFF;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--common-bg); color: var(--text-light); -webkit-tap-highlight-color: transparent; }
        .calculator-container { max-width: 400px; margin: auto; padding: 20px; touch-action: manipulation; }
        .display { font-family: 'Roboto Mono', monospace; background-color: var(--display-bg); padding: 20px; font-size: 3rem; text-align: right; border-radius: 12px; margin-bottom: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .keypad button { font-family: 'Inter', sans-serif; height: 80px; font-size: 2rem; border-radius: 50%; border: none; cursor: pointer; transition: background-color 0.2s; }
        .keypad .btn-number { background-color: var(--btn-bg); color: var(--text-light); }
        .keypad .btn-number:hover { background-color: var(--btn-hover-bg); }
        .keypad .btn-operator { background-color: var(--operator-bg); color: var(--text-light); }
        .keypad .btn-operator:hover { background-color: var(--operator-hover-bg); }
        .keypad .btn-special { background-color: var(--special-bg); color: var(--special-text); }
        .keypad .btn-zero { grid-column: span 2; border-radius: 40px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="calculator-container w-full">
        <div id="common-display" class="display">0</div>
        <div class="keypad">
            <button class="btn-special" onclick="handleInput('clear')">C</button>
            <button class="btn-special" onclick="handleInput('backspace')">⌫</button>
            <button class="btn-special" onclick="handleInput('percent')">%</button>
            <button class="btn-operator" onclick="handleInput('operator', '/')">÷</button>
            <button class="btn-number" onclick="handleInput('digit', '7')">7</button>
            <button class="btn-number" onclick="handleInput('digit', '8')">8</button>
            <button class="btn-number" onclick="handleInput('digit', '9')">9</button>
            <button class="btn-operator" onclick="handleInput('operator', '*')">×</button>
            <button class="btn-number" onclick="handleInput('digit', '4')">4</button>
            <button class="btn-number" onclick="handleInput('digit', '5')">5</button>
            <button class="btn-number" onclick="handleInput('digit', '6')">6</button>
            <button class="btn-operator" onclick="handleInput('operator', '-')">−</button>
            <button class="btn-number" onclick="handleInput('digit', '1')">1</button>
            <button class="btn-number" onclick="handleInput('digit', '2')">2</button>
            <button class="btn-number" onclick="handleInput('digit', '3')">3</button>
            <button class="btn-operator" onclick="handleInput('operator', '+')">+</button>
            <button class="btn-number btn-zero" onclick="handleInput('digit', '0')">0</button>
            <button class="btn-number" onclick="handleInput('decimal', ',')">,</button>
            <button class="btn-operator" onclick="calculate()">=</button>
        </div>
    </div>

    <script>
        const auth = firebase.auth();
        const database = firebase.database();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snapshot = await database.ref(`users_public_list/${user.uid}`).get();
                    if (snapshot.exists() && snapshot.val().isBlocked) {
                        alert("Sua conta foi bloqueada. Contate o suporte.");
                        window.location.replace('../dashboard.html');
                    }
                } catch (error) {
                    console.error("Erro ao verificar status do usuário:", error);
                    alert("Não foi possível verificar o status da sua conta.");
                }
            } else {
                window.location.replace('../index.html');
            }
        });

        const state = {
            expression: '',
            isResult: false,
            displayLimit: 15
        };

        function vibrate() {
            if ('vibrate' in navigator) navigator.vibrate(50);
        }

        function handleInput(type, value) {
            vibrate();

            if (state.isResult && type !== 'operator') {
                state.expression = '';
            }
            state.isResult = false;

            switch (type) {
                case 'digit':
                case 'decimal':
                    state.expression += (value === ',') ? '.' : value;
                    break;
                case 'operator':
                    state.expression += ` ${value} `;
                    break;
                case 'clear':
                    state.expression = '';
                    break;
                case 'backspace':
                    state.expression = state.expression.trim().slice(0, -1).trim();
                    break;
                case 'percent':
                    applyPercentage();
                    break;
            }
            updateDisplay();
        }
        
        function applyPercentage() {
            try {
                // Find the last number and the operator before it
                const parts = state.expression.trim().split(' ');
                if (parts.length < 1) return;
        
                const lastPart = parts[parts.length - 1];
                const numberToPercent = parseFloat(lastPart);
        
                if (isNaN(numberToPercent)) return;
        
                let resultPercent;
                // If it's a simple percentage (e.g., "50%") or part of multiplication/division
                if (parts.length < 3 || ['*', '/'].includes(parts[parts.length - 2])) {
                    resultPercent = numberToPercent / 100;
                } else { // For addition/subtraction (e.g., "100 + 10%")
                    const baseValue = math.evaluate(parts.slice(0, -2).join(' '));
                    resultPercent = (numberToPercent / 100) * baseValue;
                }
        
                parts[parts.length - 1] = resultPercent.toString();
                state.expression = parts.join(' ');
                calculate(); // Calculate immediately after applying percent
            } catch (error) {
                state.expression = 'Error';
                state.isResult = true;
            }
        }

        function calculate() {
            vibrate();
            if (state.expression === '' || state.expression.endsWith(' ')) return;
            try {
                const sanitizedExpression = state.expression.replace(/,/g, '.');
                let result = math.evaluate(sanitizedExpression);
                let formattedResult = math.format(result, { notation: 'fixed', precision: 10 });

                if (formattedResult.includes('.')) {
                    formattedResult = formattedResult.replace(/0+$/, '').replace(/\.$/, '');
                }
                state.expression = formattedResult;
                state.isResult = true;
            } catch (error) {
                state.expression = 'Error';
                state.isResult = true;
            }
            updateDisplay();
        }

        function formatForDisplay(text, limit) {
            let numStr = text.replace(/,/g, '.');
            if (numStr.length > limit && !numStr.includes('e')) {
                try {
                    const num = math.bignumber(numStr);
                    return math.format(num, { notation: 'exponential', precision: 5 });
                } catch (e) {}
            }
            return text.replace(/\./g, ',');
        }

        function updateDisplay() {
            const display = document.getElementById('common-display');
            let displayText = state.expression.trim() || '0';
            
            if (display) {
                const parts = displayText.split(' ');
                const lastPart = parts[parts.length - 1];
                display.textContent = formatForDisplay(lastPart, state.displayLimit);
            }
        }
        updateDisplay();
    </script>
</body>
</html>
