<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casio FX-991ES - thIAguinho Soluções</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <style>
        :root {
            --fx-shell: #E1E2E6;
            --fx-display-bg: #C1C9C5;
            --fx-keypad-bg: #D1D3D8;
            --fx-key-text: #2B2829;
            --fx-solar-panel: #3A3A3A;
            --fx-blue: #0060A8;
            --fx-red: #B92A34;
        }
        body { background-color: #333; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .calculator-body {
            position: relative; width: 350px; height: 650px; background-color: var(--fx-shell);
            border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 0 5px rgba(255,255,255,0.5);
            margin: auto; padding: 25px;
        }
        .fx-header { display: flex; justify-content: space-between; align-items: center; color: var(--fx-blue); }
        .fx-display-area { background-color: var(--fx-display-bg); border-radius: 8px; padding: 10px; margin: 15px 0; border: 2px solid #B0B8B4; }
        #fx-input { font-family: 'Roboto Mono', monospace; height: 25px; font-size: 1.2rem; text-align: right; color: #333; overflow-x: auto; white-space: nowrap; }
        #fx-result { font-family: 'Roboto Mono', monospace; height: 40px; font-size: 2.2rem; text-align: right; color: #000; font-weight: bold; overflow-x: auto; white-space: nowrap; }
        .fx-keypad button { position: absolute; font-size: 1rem; border: none; border-radius: 5px; background-color: var(--fx-keypad-bg); color: var(--fx-key-text); box-shadow: 0 2px 3px rgba(0,0,0,0.2), inset 0 -1px 1px rgba(0,0,0,0.1); cursor: pointer; }
        .fx-keypad button:active { transform: translateY(1px); box-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        /* Posicionamento dos botões (mantido para fidelidade visual) */
        .btn-sin { top: 250px; left: 30px; } .btn-cos { top: 250px; left: 105px; } .btn-tan { top: 250px; left: 180px; }
        .btn-7 { top: 320px; left: 30px; width: 60px; height: 50px; } .btn-8 { top: 320px; left: 105px; width: 60px; height: 50px; } .btn-9 { top: 320px; left: 180px; width: 60px; height: 50px; }
        .btn-4 { top: 385px; left: 30px; width: 60px; height: 50px; } .btn-5 { top: 385px; left: 105px; width: 60px; height: 50px; } .btn-6 { top: 385px; left: 180px; width: 60px; height: 50px; }
        .btn-1 { top: 450px; left: 30px; width: 60px; height: 50px; } .btn-2 { top: 450px; left: 105px; width: 60px; height: 50px; } .btn-3 { top: 450px; left: 180px; width: 60px; height: 50px; }
        .btn-0 { top: 515px; left: 30px; width: 60px; height: 50px; } .btn-dot { top: 515px; left: 105px; width: 60px; height: 50px; } .btn-ans { top: 515px; left: 180px; width: 60px; height: 50px; }
        .btn-add { top: 450px; left: 255px; width: 60px; height: 50px; } .btn-sub { top: 385px; left: 255px; width: 60px; height: 50px; }
        .btn-mul { top: 320px; left: 255px; width: 60px; height: 50px; } .btn-div { top: 250px; left: 255px; width: 60px; height: 50px; }
        .btn-eq { top: 515px; left: 255px; width: 60px; height: 50px; background-color: var(--fx-blue); color: white; }
        .btn-ac { top: 180px; left: 255px; width: 60px; height: 50px; background-color: var(--fx-red); color: white; }
        .btn-lparen { top: 180px; left: 30px; width: 60px; height: 50px; } .btn-rparen { top: 180px; left: 105px; width: 60px; height: 50px; }
        .btn-percent { top: 180px; left: 180px; width: 60px; height: 50px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="calculator-body">
        <div class="fx-header">
            <span class="font-bold text-lg">thIAguinho</span>
            <span>FX-991ES</span>
        </div>
        <div class="fx-display-area">
            <div id="fx-input"></div>
            <div id="fx-result">0</div>
        </div>
        <div class="fx-keypad">
            <button class="btn-sin" onclick="handleInput('func', 'sin(')">sin</button>
            <button class="btn-cos" onclick="handleInput('func', 'cos(')">cos</button>
            <button class="btn-tan" onclick="handleInput('func', 'tan(')">tan</button>
            <button class="btn-lparen" onclick="handleInput('lparen', '(')">(</button>
            <button class="btn-rparen" onclick="handleInput('rparen', ')')">)</button>
            <button class="btn-percent" onclick="handleInput('percent', '%')">%</button>
            <button class="btn-7" onclick="handleInput('digit', '7')">7</button>
            <button class="btn-8" onclick="handleInput('digit', '8')">8</button>
            <button class="btn-9" onclick="handleInput('digit', '9')">9</button>
            <button class="btn-4" onclick="handleInput('digit', '4')">4</button>
            <button class="btn-5" onclick="handleInput('digit', '5')">5</button>
            <button class="btn-6" onclick="handleInput('digit', '6')">6</button>
            <button class="btn-1" onclick="handleInput('digit', '1')">1</button>
            <button class="btn-2" onclick="handleInput('digit', '2')">2</button>
            <button class="btn-3" onclick="handleInput('digit', '3')">3</button>
            <button class="btn-0" onclick="handleInput('digit', '0')">0</button>
            <button class="btn-dot" onclick="handleInput('decimal', ',')">.</button>
            <button class="btn-ans" onclick="handleInput('ans', 'Ans')">Ans</button>
            <button class="btn-mul" onclick="handleInput('operator', '*')">×</button>
            <button class="btn-div" onclick="handleInput('operator', '/')">÷</button>
            <button class="btn-add" onclick="handleInput('operator', '+')">+</button>
            <button class="btn-sub" onclick="handleInput('operator', '-')">−</button>
            <button class="btn-ac" onclick="handleInput('clear', 'AC')">AC</button>
            <button class="btn-eq" onclick="calculate()">=</button>
        </div>
    </div>
    <script>
        const auth = firebase.auth();
        const database = firebase.database();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snapshot = await database.ref(`users_public_list/${user.uid}`).get();
                    if (snapshot.exists() && snapshot.val().isBlocked) {
                        alert("Sua conta foi bloqueada. Contate o suporte.");
                        window.location.replace('../dashboard.html');
                    }
                } catch (error) {
                    console.error("Erro ao verificar status do usuário:", error);
                    alert("Não foi possível verificar o status da sua conta.");
                }
            } else {
                window.location.replace('../index.html');
            }
        });

        const state = {
            expression: '',
            isResult: false,
            lastResult: '0',
            angleMode: 'deg', // 'deg' or 'rad'
            displayLimit: 15
        };

        const parser = math.parser();

        function vibrate() {
            if ('vibrate' in navigator) navigator.vibrate(50);
        }

        function handleInput(type, value) {
            vibrate();

            if (state.isResult && type !== 'operator' && type !== 'percent') {
                state.expression = '';
            }
            if (state.isResult && type === 'operator') {
                state.expression = `Ans ${value} `;
            }
            state.isResult = false;

            switch (type) {
                case 'digit':
                case 'func':
                case 'lparen':
                case 'rparen':
                    state.expression += value;
                    break;
                case 'decimal':
                     state.expression += '.';
                    break;
                case 'operator':
                    state.expression += ` ${value} `;
                    break;
                case 'clear':
                    state.expression = '';
                    break;
                case 'ans':
                    state.expression += 'Ans';
                    break;
                case 'percent':
                     applyScientificPercentage();
                    break;
            }
            updateDisplay();
        }
        
        function applyScientificPercentage() {
            // Logic for Casio-style percentage
            try {
                const parts = state.expression.trim().split(' ');
                 if (parts.length < 1) return;
        
                const lastPart = parts[parts.length - 1];
                const numberToPercent = parseFloat(lastPart);
        
                if (isNaN(numberToPercent)) return;

                let resultPercent;
                 if (parts.length >= 3 && ['+', '-'].includes(parts[parts.length - 2])) {
                    // For A + B% or A - B%, it's A * (B/100)
                    const baseValue = math.evaluate(parts.slice(0, -2).join(' '));
                    resultPercent = (numberToPercent / 100) * baseValue;
                } else {
                    // For A * B% or A / B% or just B%, it's B/100
                    resultPercent = numberToPercent / 100;
                }

                parts[parts.length - 1] = resultPercent.toString();
                state.expression = parts.join(' ');
            } catch(e) {
                state.expression = "Error";
                state.isResult = true;
            }
        }

        function calculate() {
            vibrate();
            if (state.expression.trim() === '') return;
            try {
                parser.clear();
                parser.set('Ans', math.bignumber(state.lastResult));
                
                // Handle angle mode for trig functions
                const radExpr = state.expression.replace(/(sin|cos|tan)\(/g, (match, func) => {
                    return state.angleMode === 'deg' ? `${func}d(` : `${func}(`;
                });

                const result = parser.evaluate(radExpr);
                let formattedResult = math.format(result, { notation: 'fixed', precision: 12 });
                
                if (formattedResult.includes('.')) {
                   formattedResult = formattedResult.replace(/0+$/, '').replace(/\.$/, '');
                }

                state.expression = formattedResult;
                state.lastResult = formattedResult; // Update Ans
                state.isResult = true;
            } catch (error) {
                state.expression = 'Error';
                state.isResult = true;
            }
            updateDisplay();
        }

        function formatForDisplay(text, limit) {
             let numStr = String(text).replace(/,/g, '.');
            if (numStr.length > limit && !numStr.includes('e')) {
                try {
                    const num = math.bignumber(numStr);
                    return math.format(num, { notation: 'exponential', precision: 5 });
                } catch (e) {}
            }
            return String(text).replace(/\./g, ',');
        }

        function updateDisplay() {
            const mainDisplay = document.getElementById('fx-result');
            const secondaryDisplay = document.getElementById('fx-input');
            
            if (!mainDisplay || !secondaryDisplay) return;

            if(state.isResult) {
                secondaryDisplay.textContent = state.expression.trim().replace(/\*/g, '×').replace(/\//g, '÷') + "=";
                mainDisplay.textContent = formatForDisplay(state.expression, state.displayLimit);
            } else {
                secondaryDisplay.textContent = state.expression.trim().replace(/\*/g, '×').replace(/\//g, '÷');
                mainDisplay.textContent = '0'; // Or show last number, depends on desired logic
            }
            
            if (state.expression.trim() === '') {
                 secondaryDisplay.textContent = '';
                 mainDisplay.textContent = '0';
            }
        }
        updateDisplay();
    </script>
</body>
</html>
